<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>setup-organizer</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111217">

  <style>
    :root{
      --bg:#0f0f10;
      --card:#16171a;
      --muted:#a8abb2;
      --text:#f2f2f3;
      --line:#2a2c33;
      --accent:#4f7cff;
      --danger:#fb7185;
      --ok:#22c55e;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(15,15,16,.92);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .spacer{flex:1}
    .btn{
      appearance:none;border:1px solid var(--line);background:var(--card);color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800;font-size:13px;
    }
    .btn.primary{border-color:transparent;background:linear-gradient(180deg,#2f5eff,#2247c9)}
    .btn.ghost{background:transparent}
    .btn.danger{border-color:transparent;background:linear-gradient(180deg,#881337,#500724)}
    .btn.ok{border-color:transparent;background:linear-gradient(180deg,#14532d,#0b3b1e)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px}
    .meta{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .two{display:grid;grid-template-columns: 380px 1fr;gap:12px}
    @media (max-width: 980px){ .two{grid-template-columns:1fr;}}

    input, textarea, select{
      width:100%;padding:10px 11px;border-radius:12px;border:1px solid var(--line);
      background:#0c0d10;color:var(--text);outline:none;font-size:14px;
    }
    textarea{min-height:80px;resize:vertical}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius:14px;border:1px solid var(--line);background:#121318;
    }
    .item strong{display:block;font-size:14px}
    .actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px}
    .tag{display:inline-block;margin-left:8px;font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted)}
    .tag.rd{border-color: rgba(34,197,94,.35); color: rgba(187,247,208,.95)}

    /* PDF stage */
    .stageWrap{
      background:#0b0c10;
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
    }
    .stageScroller{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border-radius:12px;
      background:#0b0c10;
      min-height:520px;
    }
    .stage{
      position:relative;
      display:inline-block;
      transform-origin: top left;
    }
    canvas{display:block;border-radius:10px}

    /* Overlay fields */
    .fld, .chk, .rad{
      position:absolute;
      font: 12px system-ui, sans-serif;
      outline:none;
    }
    .fld{
      padding:2px 4px;
      border:1px solid rgba(79,124,255,.55);
      background:rgba(12,13,16,.65);
      color:var(--text);
      border-radius:6px;
    }
    .fld.small{font-size:11px;padding:1px 3px}
    .chk, .rad{
      width:16px;height:16px;
      accent-color: var(--accent);
      background:rgba(12,13,16,.65);
      border-radius:4px;
    }
    .readonlyOverlay input,
    .readonlyOverlay textarea{
      pointer-events:none !important;
      opacity:.85;
    }

    .err{
      padding:12px;
      border:1px solid rgba(251,113,133,.5);
      background:rgba(136,19,55,.15);
      border-radius:14px;
      margin-top:10px;
      color:#ffd1d9;
      font-size:13px;
      white-space:pre-wrap;
    }

    .racedayPanel{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:#0d0e12;
    }
    .racedayPanel h3{margin:0 0 6px 0;font-size:13px}
    .tiny{font-size:12px;color:var(--muted)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr;} }

    .lapList{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .lapItem{
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:10px;
      background: rgba(255,255,255,.03);
      cursor:pointer;
    }
    .lapItem:hover{border-color: rgba(255,255,255,.18)}
    .lapItem.active{
      border-color: rgba(79,124,255,.55);
      background: rgba(79,124,255,.10);
    }
    .lapHead{display:flex;gap:10px;align-items:center}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .roBanner{
      margin-top:10px;
      border:1px solid rgba(79,124,255,.45);
      background: rgba(79,124,255,.10);
      border-radius:12px;
      padding:10px;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.7.570/pdf.min.js"></script>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <div>
        <h1>setup-organizer</h1>
        <div class="sub">X4F 2024 · PDF-formfält (100%)</div>
      </div>
      <div class="spacer"></div>

      <button class="btn ghost" id="btnRaceToggle" title="Skapar ett Raceday-projekt av nuvarande setup">Raceday</button>
      <button class="btn ghost" id="btnNew">Ny setup</button>
      <button class="btn primary" id="btnSave">Spara</button>
      <button class="btn danger" id="btnDelete" style="display:none">Radera</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="two">

    <section class="card">
      <div style="font-weight:900">Factory baselines</div>
      <div class="meta">Låsta mallar (kopiera som ny)</div>
      <div class="hr"></div>
      <div class="list" id="baselineList"></div>

      <div class="hr"></div>

      <div style="font-weight:900">Mina setuper</div>
      <div class="meta">Sök + filter</div>

      <div class="row" style="margin-top:10px">
        <input id="q" placeholder="Sök: bana, däck, kommentar...">
      </div>
      <div class="row" style="margin-top:10px">
        <input id="fSurface" placeholder="Filter underlag (carpet/asphalt)">
        <input id="fTraction" placeholder="Filter grepp (low/medium/high)">
      </div>

      <div class="hr"></div>
      <div class="list" id="myList"></div>
      <div class="meta" id="emptyHint" style="display:none">Inga setuper än.</div>
    </section>

    <section class="stageWrap">
      <div class="row" style="margin-bottom:10px">
        <span class="pill" id="statusPill">Laddar sheet.pdf…</span>
        <span class="pill">Källa: sheet.pdf</span>
      </div>

      <div class="stageScroller">
        <div class="stage" id="stage">
          <canvas id="pdfCanvas"></canvas>
        </div>
      </div>

      <div class="racedayPanel" id="racedayPanel" style="display:none">
        <div class="row" style="align-items:flex-end">
          <div style="flex:1;min-width:220px">
            <h3>Raceday</h3>
            <div class="tiny" id="racedayMeta"></div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <div>
            <div class="tiny">Projektnamn</div>
            <input id="racedayName" placeholder="Raceday YYYY-MM-DD – TRACK">
          </div>
          <div>
            <div class="tiny">Ny varvtid</div>
            <div class="row" style="gap:8px">
              <input id="lapTime" placeholder="t.ex. 14,56">
              <button class="btn ok" id="btnSaveLap">Spara varvtid</button>
            </div>
            <div class="tiny">När du sparar varvtid sparas hela setupen som en snapshot.</div>
          </div>
        </div>

        <div class="roBanner" id="roBanner" style="display:none">
          <div class="row">
            <div style="flex:1">
              <div style="font-weight:900">READ ONLY</div>
              <div class="tiny" id="roText"></div>
            </div>
            <button class="btn" id="btnBackToLive">Tillbaka till live</button>
            <button class="btn primary" id="btnContinueFromLap">Fortsätt från denna</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="tiny">Sparade varvtider (klicka för att visa snapshot)</div>
        <div class="lapList" id="lapList"></div>
      </div>

      <div class="meta" style="margin-top:10px">
        Om du vill skriva i små rutor: zooma in med webbläsarens pinch-zoom.
      </div>

      <div id="errBox" class="err" style="display:none"></div>
    </section>

  </div>
</main>

<script>
(() => {
  // ---------- UI refs ----------
  const baselineList = document.getElementById('baselineList');
  const myList = document.getElementById('myList');
  const emptyHint = document.getElementById('emptyHint');
  const q = document.getElementById('q');
  const fSurface = document.getElementById('fSurface');
  const fTraction = document.getElementById('fTraction');

  const btnRaceToggle = document.getElementById('btnRaceToggle');
  const btnNew = document.getElementById('btnNew');
  const btnSave = document.getElementById('btnSave');
  const btnDelete = document.getElementById('btnDelete');

  const statusPill = document.getElementById('statusPill');
  const errBox = document.getElementById('errBox');

  const stage = document.getElementById('stage');
  const canvas = document.getElementById('pdfCanvas');
  const ctx = canvas.getContext('2d', { alpha:false });

  const racedayPanel = document.getElementById('racedayPanel');
  const racedayMeta = document.getElementById('racedayMeta');
  const racedayName = document.getElementById('racedayName');
  const lapTime = document.getElementById('lapTime');
  const btnSaveLap = document.getElementById('btnSaveLap');
  const lapList = document.getElementById('lapList');

  const roBanner = document.getElementById('roBanner');
  const roText = document.getElementById('roText');
  const btnBackToLive = document.getElementById('btnBackToLive');
  const btnContinueFromLap = document.getElementById('btnContinueFromLap');

  // ---------- SW ----------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(() => {}));
  }

  // ---------- errors ----------
  function showError(msg){
    errBox.style.display = '';
    errBox.textContent = String(msg ?? '');
  }
  window.addEventListener("error", (e) => showError("JS-fel:\n" + (e?.message || e)));
  window.addEventListener("unhandledrejection", (e) => showError("Promise-fel:\n" + (e?.reason?.message || e?.reason || e)));

  // ---------- utils ----------
  const KEY = 'setup_organizer_projects_v2';
  const uid = () => Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
  const nowISO = () => new Date().toISOString();
  const norm = (s) => String(s ?? '').trim().toLowerCase();
  const deepCopy = (o) => JSON.parse(JSON.stringify(o));

  const escapeHtml = (s) =>
    String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");

  const fmtTime = (iso) => {
    try{
      const d = new Date(iso);
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }catch{ return ''; }
  };

  function loadAll(){
    try{
      const raw = localStorage.getItem(KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function saveAll(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
  }

  // ---------- data ----------
  let all = loadAll().sort((a,b)=> (b.meta?.updatedAt||'').localeCompare(a.meta?.updatedAt||''));
  let current = null;

  function newBlankProject(){
    return {
      id: uid(),
      meta: {
        name: "Ny setup",
        createdAt: nowISO(),
        updatedAt: nowISO(),
        isRaceday: false
      },
      fields: {},
      raceday: null
    };
  }

  const PDFS = {
    carpet: "https://teamxray.com/downloads/95/x4f_2024_set_up_basic_for_ets_carpet.pdf",
    asphalt: "https://teamxray.com/downloads/20/x4f_2024_set_up_basic_for_ets_asphalt.pdf"
  };

  function deriveSurfaceTraction(project){
    const f = project.fields || {};
    const surface =
      (f["CARPET"] || f["Carpet"] || f["carpet"]) ? "carpet" :
      (f["ASPHALT"] || f["Asphalt"] || f["asphalt"]) ? "asphalt" : "";
    const traction =
      (f["HIGH"] || f["High"] || f["high"]) ? "high" :
      (f["MEDIUM"] || f["Medium"] || f["medium"]) ? "medium" :
      (f["LOW"] || f["Low"] || f["low"]) ? "low" : "";
    return { surface, traction };
  }

  function matchFilters(project){
    const term = norm(q.value);
    const sf = norm(fSurface.value);
    const tf = norm(fTraction.value);
    const {surface, traction} = deriveSurfaceTraction(project);

    if (sf && !surface.includes(sf)) return false;
    if (tf && !traction.includes(tf)) return false;

    if (!term) return true;
    const hay = norm(JSON.stringify({ name: project.meta?.name, fields: project.fields, raceday: project.raceday }));
    return hay.includes(term);
  }

  function listLabel(project){
    const f = project.fields || {};
    const track = (f["TRACK"] || f["Track"] || f["track"] || f["RACE"] || f["Race"] || f["race"] || "");
    const date  = (f["DATE"] || f["Date"] || f["date"] || "");
    const {surface, traction} = deriveSurfaceTraction(project);
    const parts = [date, track, surface, traction].filter(Boolean);
    return {
      title: project.meta?.name || (track ? String(track) : "(ingen titel)"),
      meta: parts.join(' · '),
      isRaceday: !!project.meta?.isRaceday
    };
  }

  function persistCurrent(){
    if (!current) return;
    const arr = loadAll();
    const idx = arr.findIndex(x => x.id === current.id);
    if (idx >= 0) arr[idx] = current;
    else arr.unshift(current);
    saveAll(arr);
    all = loadAll().sort((a,b)=> (b.meta?.updatedAt||'').localeCompare(a.meta?.updatedAt||''));
  }

  function refreshStatus(){
    if (!pdfDoc){
      statusPill.textContent = 'Laddar sheet.pdf…';
      btnDelete.style.display = 'none';
      return;
    }
    if (!current){
      statusPill.textContent = 'Ingen setup vald';
      btnDelete.style.display = 'none';
      return;
    }
    const rd = current.meta?.isRaceday ? " · Raceday" : "";
    statusPill.textContent = `Vald setup · fält: ${Object.keys(current.fields||{}).length}${rd}`;
    btnDelete.style.display = '';
  }

  // ---------- baselines + list ----------
  function renderBaselines(){
    baselineList.innerHTML = '';
    const baselines = [
      { kind:'carpet', title:'XRAY Basic ETS Carpet', meta:'Carpet · High', pdf:PDFS.carpet },
      { kind:'asphalt', title:'XRAY Basic ETS Asphalt', meta:'Asphalt · Medium', pdf:PDFS.asphalt },
    ];

    for (const b of baselines){
      const el = document.createElement('div');
      el.className = 'item';

      const left = document.createElement('div');
      left.innerHTML = `<strong>${escapeHtml(b.title)}</strong><small>${escapeHtml(b.meta)}</small>`;

      const actions = document.createElement('div');
      actions.className = 'actions';

      const copy = document.createElement('button');
      copy.className = 'btn';
      copy.textContent = 'Kopiera som ny';
      copy.onclick = () => {
        const p = newBlankProject();
        p.meta.name = b.title;
        if (b.kind === 'carpet'){ p.fields["CARPET"] = true; p.fields["HIGH"] = true; }
        else { p.fields["ASPHALT"] = true; p.fields["MEDIUM"] = true; }

        all.unshift(p);
        saveAll(all);
        current = p;
        renderMyList();
        setViewingLap(null);
        populateOverlay();
        updateRacedayUI();
        refreshStatus();
      };

      const pdf = document.createElement('button');
      pdf.className = 'btn ghost';
      pdf.textContent = 'Öppna PDF';
      pdf.onclick = () => window.open(b.pdf, '_blank');

      actions.append(copy, pdf);
      el.append(left, actions);
      baselineList.appendChild(el);
    }
  }

  function renderMyList(){
    all = loadAll().sort((a,b)=> (b.meta?.updatedAt||'').localeCompare(a.meta?.updatedAt||''));
    const filtered = all.filter(matchFilters);

    myList.innerHTML = '';
    emptyHint.style.display = filtered.length ? 'none' : 'block';

    for (const p of filtered){
      const {title, meta, isRaceday} = listLabel(p);

      const el = document.createElement('div');
      el.className = 'item';

      const left = document.createElement('div');
      left.innerHTML = `
        <strong>${escapeHtml(title)} ${isRaceday ? '<span class="tag rd">Raceday</span>' : ''}</strong>
        <small>${escapeHtml(meta)}</small>
      `;

      const actions = document.createElement('div');
      actions.className = 'actions';

      const open = document.createElement('button');
      open.className = 'btn';
      open.textContent = 'Öppna';
      open.onclick = () => {
        current = p;
        setViewingLap(null);
        populateOverlay();
        updateRacedayUI();
        refreshStatus();
      };

      const dup = document.createElement('button');
      dup.className = 'btn ghost';
      dup.textContent = 'Kopiera';
      dup.onclick = () => {
        const copy = deepCopy(p);
        copy.id = uid();
        copy.meta.createdAt = nowISO();
        copy.meta.updatedAt = nowISO();
        copy.meta.name = (copy.meta.name || "Setup") + " (kopia)";
        // kopia av raceday: behåll laps men nollställ view
        if (copy.raceday) copy.raceday.viewLapId = null;
        all.unshift(copy);
        saveAll(all);
        renderMyList();
      };

      actions.append(open, dup);
      el.append(left, actions);
      myList.appendChild(el);
    }
  }

  function hardSave(){
    if (!current){
      current = newBlankProject();
      all.unshift(current);
    }
    current.meta.updatedAt = nowISO();
    persistCurrent();
    renderMyList();
    alert('Sparad.');
  }

  function hardDelete(){
    if (!current) return;
    const arr = loadAll().filter(x => x.id !== current.id);
    saveAll(arr);
    current = null;
    renderMyList();
    clearOverlay();
    updateRacedayUI();
    refreshStatus();
  }

  // ---------- Raceday ----------
  function ensureRacedayStruct(project){
    if (!project.raceday){
      project.raceday = {
        laps: [],         // {id, lapTime, savedAt, fields}
        viewLapId: null   // active read-only lap
      };
    }
  }

  function racedayActive(){
    return !!(current && current.meta?.isRaceday && current.raceday);
  }

  function guessTrackName(){
    const f = current?.fields || {};
    const track = f["TRACK"] || f["Track"] || f["track"] || f["RACE"] || f["Race"] || f["race"] || "";
    return String(track || "TRACK").trim() || "TRACK";
  }

  function startRaceday(){
    if (!current){
      current = newBlankProject();
      all.unshift(current);
    }

    // Create NEW project as raceday copy
    const p = deepCopy(current);
    p.id = uid();
    p.meta = {
      ...p.meta,
      isRaceday: true,
      createdAt: nowISO(),
      updatedAt: nowISO()
    };

    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const track = guessTrackName();
    p.meta.name = `Raceday ${yyyy}-${mm}-${dd} – ${track}`;

    ensureRacedayStruct(p);

    all.unshift(p);
    saveAll(all);
    current = p;

    renderMyList();
    setViewingLap(null);
    populateOverlay();
    updateRacedayUI();
    refreshStatus();
  }

  function setViewingLap(lapId){
    if (!racedayActive()) return;
    current.raceday.viewLapId = lapId;
    current.meta.updatedAt = nowISO();
    persistCurrent();
  }

  function getViewingLap(){
    if (!racedayActive()) return null;
    const id = current.raceday.viewLapId;
    if (!id) return null;
    return current.raceday.laps.find(x => x.id === id) || null;
  }

  function saveLapSnapshot(){
    if (!racedayActive()) return;

    const lt = String(lapTime.value || '').trim();
    if (!lt){
      alert("Fyll i varvtid (t.ex. 14,56).");
      return;
    }

    // Always snapshot from LIVE fields (not read-only view)
    const lap = {
      id: uid(),
      lapTime: lt,
      savedAt: nowISO(),
      fields: deepCopy(current.fields || {})
    };

    current.raceday.laps.push(lap);
    lapTime.value = '';
    current.meta.updatedAt = nowISO();
    persistCurrent();

    renderMyList();
    updateRacedayUI();
  }

  function continueFromLap(){
    const lap = getViewingLap();
    if (!lap) return;

    // Copy snapshot into live fields, exit read-only
    current.fields = deepCopy(lap.fields || {});
    setViewingLap(null);

    current.meta.updatedAt = nowISO();
    persistCurrent();

    populateOverlay();
    updateRacedayUI();
    refreshStatus();
  }

  function backToLive(){
    if (!racedayActive()) return;
    setViewingLap(null);
    populateOverlay();
    updateRacedayUI();
    refreshStatus();
  }

  function updateRacedayUI(){
    const active = racedayActive();
    racedayPanel.style.display = active ? '' : 'none';

    if (!active){
      btnRaceToggle.textContent = 'Raceday';
      stage.classList.remove('readonlyOverlay');
      roBanner.style.display = 'none';
      return;
    }

    btnRaceToggle.textContent = 'Raceday (på)';

    racedayName.value = current.meta?.name || '';
    const {surface, traction} = deriveSurfaceTraction(current);
    const lapsCount = current.raceday.laps.length;
    racedayMeta.textContent = `Snapshots: ${lapsCount} · Underlag: ${surface || '-'} · Grepp: ${traction || '-'}`;

    const viewing = getViewingLap();
    roBanner.style.display = viewing ? '' : 'none';
    stage.classList.toggle('readonlyOverlay', !!viewing);

    if (viewing){
      roText.innerHTML = `Visar: <span class="mono">${escapeHtml(fmtTime(viewing.savedAt))}</span> · Varvtid: <span class="mono">${escapeHtml(viewing.lapTime)}</span>`;
    }

    // Render lap list (latest first)
    lapList.innerHTML = '';
    if (!lapsCount){
      lapList.innerHTML = `<div class="tiny">Inga varvtider sparade än.</div>`;
      return;
    }

    const laps = current.raceday.laps.slice().reverse();
    for (const lap of laps){
      const el = document.createElement('div');
      el.className = 'lapItem' + (viewing && viewing.id === lap.id ? ' active' : '');
      el.innerHTML = `
        <div class="lapHead">
          <div style="flex:1">
            <div style="font-weight:900">
              <span class="mono">${escapeHtml(fmtTime(lap.savedAt))}</span> · <span class="mono">${escapeHtml(lap.lapTime)}</span>
            </div>
            <div class="tiny">${escapeHtml(current.meta?.name || '')}</div>
          </div>
        </div>
      `;
      el.onclick = () => {
        setViewingLap(lap.id);
        populateOverlay();
        updateRacedayUI();
        refreshStatus();
      };
      lapList.appendChild(el);
    }
  }

  racedayName.addEventListener('input', () => {
    if (!current) return;
    current.meta.name = racedayName.value;
    current.meta.updatedAt = nowISO();
    persistCurrent();
    renderMyList();
  });

  btnSaveLap.onclick = saveLapSnapshot;
  btnBackToLive.onclick = backToLive;
  btnContinueFromLap.onclick = continueFromLap;

  // ---------- PDF + overlay ----------
  let pdfDoc = null;
  let page = null;
  let viewport = null;
  let widgetAnnots = [];
  let overlayNodes = [];

  function clearOverlay(){
    for (const n of overlayNodes) n.remove();
    overlayNodes = [];
  }

  function pdfRectToCss(rect){
    const r = pdfjsLib.Util.normalizeRect(rect);
    const v = viewport.convertToViewportRectangle(r);
    const [x1,y1,x2,y2] = v;
    const left = Math.min(x1, x2);
    const top = Math.min(y1, y2);
    const width = Math.abs(x2 - x1);
    const height = Math.abs(y2 - y1);
    return { left, top, width, height };
  }

  function getSourceFields(){
    const viewing = getViewingLap();
    return viewing ? (viewing.fields || {}) : (current?.fields || {});
  }

  function setOverlayDisabled(disabled){
    for (const el of overlayNodes){
      if (el.type === 'checkbox' || el.type === 'radio' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA'){
        el.disabled = !!disabled;
      }
    }
  }

  function buildOverlayNodes(widgets){
    clearOverlay();

    // finjustera kryss/radio
    const OX = -2; // vänster
    const OY = -2; // upp

    for (const w of widgets){
      const { left, top, width, height } = pdfRectToCss(w.rect);
      const t = w.fieldType;

      const cx = left + width / 2;
      const cy = top + height / 2;

      if (t === "Btn"){
        const box = Math.max(12, Math.min(16, (Math.min(width, height) || 16)));

        if (w.radioButton){
          const el = document.createElement('input');
          el.type = 'radio';
          el.className = 'rad';
          el.name = w.fieldName;
          el.value = w.exportValue || "On";
          el.dataset.fname = w.fieldName;

          el.style.left = (cx - box/2 + OX) + "px";
          el.style.top  = (cy - box/2 + OY) + "px";
          el.style.width  = box + "px";
          el.style.height = box + "px";

          el.addEventListener('change', () => {
            if (!current) return;
            if (getViewingLap()) return; // read-only
            current.fields[w.fieldName] = el.value;
            current.meta.updatedAt = nowISO();
            persistCurrent();
            renderMyList();
            refreshStatus();
          });

          stage.appendChild(el);
          overlayNodes.push(el);
        } else {
          const el = document.createElement('input');
          el.type = 'checkbox';
          el.className = 'chk';
          el.dataset.fname = w.fieldName;

          el.style.left = (cx - box/2 + OX) + "px";
          el.style.top  = (cy - box/2 + OY) + "px";
          el.style.width  = box + "px";
          el.style.height = box + "px";

          el.addEventListener('change', () => {
            if (!current) return;
            if (getViewingLap()) return; // read-only
            current.fields[w.fieldName] = el.checked;
            current.meta.updatedAt = nowISO();
            persistCurrent();
            renderMyList();
            refreshStatus();
          });

          stage.appendChild(el);
          overlayNodes.push(el);
        }
      } else if (t === "Tx") {
        const isMulti = !!w.multiLine || ((w.fieldFlags || 0) & 4096) === 4096;
        const el = document.createElement(isMulti ? 'textarea' : 'input');
        if (!isMulti) el.type = 'text';

        el.className = 'fld' + (height < 20 ? ' small' : '');
        el.dataset.fname = w.fieldName;

        el.style.left = left + "px";
        el.style.top = top + "px";
        el.style.width = Math.max(width, 40) + "px";
        el.style.height = Math.max(isMulti ? 40 : 18, height) + "px";

        el.addEventListener('input', () => {
          if (!current) return;
          if (getViewingLap()) return; // read-only
          current.fields[w.fieldName] = el.value;
          current.meta.updatedAt = nowISO();
          persistCurrent();
          renderMyList();
          refreshStatus();
        });

        stage.appendChild(el);
        overlayNodes.push(el);
      }
    }

    populateOverlay();
  }

  function populateOverlay(){
    const f = getSourceFields();
    const nodes = stage.querySelectorAll('input, textarea');

    for (const el of nodes){
      const fieldName = el.dataset.fname || el.name || '';
      if (!fieldName) continue;

      if (el.type === 'radio'){
        const wanted = f[fieldName];
        el.checked = wanted ? (String(wanted) === String(el.value)) : false;
      } else if (el.type === 'checkbox'){
        el.checked = !!f[fieldName];
      } else {
        el.value = String(f[fieldName] ?? '');
      }
    }

    setOverlayDisabled(!!getViewingLap());
  }

  async function loadPdfAndBuildOverlay(){
    const pdfUrl = "./sheet.pdf?v=" + Date.now();

    const timeoutId = setTimeout(() => {
      statusPill.textContent = "Fastnade vid PDF-laddning";
      showError("PDF-laddningen fastnade.\n1) Kontrollera att sheet.pdf finns i repo-root.\n2) Bumpa CACHE_NAME i sw.js.\n3) Testa app.html?v=1");
    }, 8000);

    try{
      const r = await fetch(pdfUrl, { cache: "no-store" });
      if (!r.ok){
        clearTimeout(timeoutId);
        statusPill.textContent = `sheet.pdf fetch: ${r.status}`;
        showError(`Kunde inte hämta sheet.pdf (status ${r.status}).`);
        return;
      }

      statusPill.textContent = "Laddar PDF…";
      const loadingTask = pdfjsLib.getDocument({ url: pdfUrl, disableWorker: true });
      pdfDoc = await loadingTask.promise;
      clearTimeout(timeoutId);

      page = await pdfDoc.getPage(1);

      const scale = 1.6;
      viewport = page.getViewport({ scale });

      canvas.width = Math.ceil(viewport.width);
      canvas.height = Math.ceil(viewport.height);

      stage.style.width = canvas.width + "px";
      stage.style.height = canvas.height + "px";

      await page.render({ canvasContext: ctx, viewport }).promise;

      const annots = await page.getAnnotations({ intent: "display" });
      widgetAnnots = annots.filter(a => a.subtype === "Widget" && a.fieldName);

      buildOverlayNodes(widgetAnnots);
      statusPill.textContent = `Laddad: ${widgetAnnots.length} fält`;
      refreshStatus();
    } catch(e){
      clearTimeout(timeoutId);
      showError("PDF-laddning misslyckades:\n" + (e && (e.message || String(e))));
      statusPill.textContent = "Kunde inte läsa sheet.pdf";
      console.error(e);
    }
  }

  // ---------- events ----------
  btnRaceToggle.onclick = () => {
    if (racedayActive()){
      racedayPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      return;
    }
    startRaceday();
  };

  btnNew.onclick = () => {
    current = newBlankProject();
    all.unshift(current);
    saveAll(all);
    renderMyList();
    clearOverlay();
    setViewingLap(null);
    populateOverlay();
    updateRacedayUI();
    refreshStatus();
  };

  btnSave.onclick = hardSave;
  btnDelete.onclick = hardDelete;

  q.addEventListener('input', renderMyList);
  fSurface.addEventListener('input', renderMyList);
  fTraction.addEventListener('input', renderMyList);

  // ---------- init ----------
  renderBaselines();
  renderMyList();

  if (!current){
    current = newBlankProject();
    all.unshift(current);
    saveAll(all);
  }

  updateRacedayUI();
  refreshStatus();
  loadPdfAndBuildOverlay();
})();
</script>
</body>
</html>
