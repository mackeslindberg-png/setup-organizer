<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>setup-organizer</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111217">

  <style>
    :root{
      --bg:#0f0f10;
      --card:#16171a;
      --muted:#a8abb2;
      --text:#f2f2f3;
      --line:#2a2c33;
      --accent:#4f7cff;
      --danger:#fb7185;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(15,15,16,.92);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px;margin-top:2px}
    .spacer{flex:1}
    .btn{
      appearance:none;border:1px solid var(--line);background:var(--card);color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800;font-size:13px;
    }
    .btn.primary{border-color:transparent;background:linear-gradient(180deg,#2f5eff,#2247c9)}
    .btn.ghost{background:transparent}
    .btn.danger{border-color:transparent;background:linear-gradient(180deg,#881337,#500724)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:12px}
    .meta{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .two{display:grid;grid-template-columns: 380px 1fr;gap:12px}
    @media (max-width: 980px){ .two{grid-template-columns:1fr;}}
    input, textarea{
      width:100%;padding:10px 11px;border-radius:12px;border:1px solid var(--line);
      background:#0c0d10;color:var(--text);outline:none;font-size:14px;
    }
    textarea{min-height:80px;resize:vertical}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius:14px;border:1px solid var(--line);background:#121318;
    }
    .item strong{display:block;font-size:14px}
    .actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px}

    /* PDF stage */
    .stageWrap{
      background:#0b0c10;
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
    }
    .stageScroller{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border-radius:12px;
      background:#0b0c10;
      min-height:520px;
    }
    .stage{
      position:relative;
      display:inline-block;
      transform-origin: top left;
    }
    canvas{display:block; border-radius:10px}

    /* Overlay fields */
    .fld, .chk, .rad{
      position:absolute;
      font: 12px system-ui, sans-serif;
      outline:none;
    }
    .fld{
      padding:2px 4px;
      border:1px solid rgba(79,124,255,.55);
      background:rgba(12,13,16,.65);
      color:var(--text);
      border-radius:6px;
    }
    .fld.small{font-size:11px;padding:1px 3px}
    .chk, .rad{
  width:12px;
  height:12px;
  accent-color: var(--accent);
  background:rgba(12,13,16,.65);
  border-radius:3px;

  /* centrera i PDF-rutan */
  transform: translate(2px, 2px);
}

    }

    .err{
      padding:12px;
      border:1px solid rgba(251,113,133,.5);
      background:rgba(136,19,55,.15);
      border-radius:14px;
      margin-top:10px;
      color:#ffd1d9;
      font-size:13px;
      white-space:pre-wrap;
    }
  </style>

  <!-- pdf.js -->
 <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.7.570/pdf.min.js"></script>

</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div>
        <h1>setup-organizer</h1>
        <div class="sub">X4F 2024 · PDF-formfält (100%)</div>
      </div>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnNew">Ny setup</button>
      <button class="btn primary" id="btnSave">Spara</button>
      <button class="btn danger" id="btnDelete" style="display:none">Radera</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="two">

    <section class="card">
      <div style="font-weight:900">Factory baselines</div>
      <div class="meta">Låsta mallar (kopiera som ny)</div>
      <div class="hr"></div>
      <div class="list" id="baselineList"></div>

      <div class="hr"></div>

      <div style="font-weight:900">Mina setuper</div>
      <div class="meta">Sök + filter</div>

      <div class="row" style="margin-top:10px">
        <input id="q" placeholder="Sök: bana, däck, kommentar...">
      </div>
      <div class="row" style="margin-top:10px">
        <input id="fSurface" placeholder="Filter underlag (carpet/asphalt)">
        <input id="fTraction" placeholder="Filter grepp (low/medium/high)">
      </div>

      <div class="hr"></div>
      <div class="list" id="myList"></div>
      <div class="meta" id="emptyHint" style="display:none">Inga setuper än.</div>
    </section>

    <section class="stageWrap">
      <div class="row" style="margin-bottom:10px">
        <span class="pill" id="statusPill">Laddar sheet.pdf…</span>
        <span class="pill">Källa: sheet.pdf</span>
      </div>

      <div class="stageScroller">
        <div class="stage" id="stage">
          <canvas id="pdfCanvas"></canvas>
        </div>
      </div>

      <div class="meta" style="margin-top:10px">
        Om du vill skriva i små rutor: zooma in med webbläsarens pinch-zoom.
      </div>

      <div id="errBox" class="err" style="display:none"></div>
    </section>

  </div>
</main>

<script>
(() => {
  // SW
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(() => {}));
  }

  // pdf.js: kör utan worker för max kompatibilitet (löser många "tom sida"-problem)
  // OBS: vi använder disableWorker i getDocument istället för workerSrc.
  // pdfjsLib.GlobalWorkerOptions.workerSrc = ... (behövs ej)

  const KEY = 'setup_organizer_pdf_fields_v1';
  const uid = () => Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
  const nowISO = () => new Date().toISOString();
  const norm = (s) => String(s ?? '').trim().toLowerCase();
  const escapeHtml = (s) =>
    String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");

  function loadAll(){
    try{
      const raw = localStorage.getItem(KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function saveAll(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
  }

  const PDFS = {
    carpet: "https://teamxray.com/downloads/95/x4f_2024_set_up_basic_for_ets_carpet.pdf",
    asphalt: "https://teamxray.com/downloads/20/x4f_2024_set_up_basic_for_ets_asphalt.pdf"
  };

  const baselineList = document.getElementById('baselineList');
  const myList = document.getElementById('myList');
  const emptyHint = document.getElementById('emptyHint');
  const q = document.getElementById('q');
  const fSurface = document.getElementById('fSurface');
  const fTraction = document.getElementById('fTraction');

  const btnNew = document.getElementById('btnNew');
  const btnSave = document.getElementById('btnSave');
  const btnDelete = document.getElementById('btnDelete');

  const statusPill = document.getElementById('statusPill');
  const errBox = document.getElementById('errBox');

  const stage = document.getElementById('stage');
  const canvas = document.getElementById('pdfCanvas');
  const ctx = canvas.getContext('2d', { alpha:false });

  let all = loadAll().sort((a,b)=> (b.meta?.updatedAt||'').localeCompare(a.meta?.updatedAt||''));
  let current = null;

  let pdfDoc = null;
  let page = null;
  let viewport = null;
  let widgetAnnots = [];

  function showError(msg){
    errBox.style.display = '';
    errBox.textContent = msg;
  }

  function newBlankSetup(){
    return { id: uid(), meta: { updatedAt: nowISO(), createdAt: nowISO() }, fields: {} };
  }

  function deriveSurfaceTraction(setup){
    const f = setup.fields || {};
    const surface =
      (f["CARPET"] || f["Carpet"] || f["carpet"]) ? "carpet" :
      (f["ASPHALT"] || f["Asphalt"] || f["asphalt"]) ? "asphalt" : "";
    const traction =
      (f["HIGH"] || f["High"] || f["high"]) ? "high" :
      (f["MEDIUM"] || f["Medium"] || f["medium"]) ? "medium" :
      (f["LOW"] || f["Low"] || f["low"]) ? "low" : "";
    return { surface, traction };
  }

  function matchFilters(setup){
    const term = norm(q.value);
    const sf = norm(fSurface.value);
    const tf = norm(fTraction.value);
    const {surface, traction} = deriveSurfaceTraction(setup);
    if (sf && !surface.includes(sf)) return false;
    if (tf && !traction.includes(tf)) return false;
    if (!term) return true;
    return norm(JSON.stringify(setup.fields || {})).includes(term);
  }

  function listLabel(setup){
    const f = setup.fields || {};
    const track = (f["TRACK"] || f["Track"] || f["track"] || f["RACE"] || f["Race"] || f["race"] || "(ingen titel)");
    const date  = (f["DATE"] || f["Date"] || f["date"] || "");
    const {surface, traction} = deriveSurfaceTraction(setup);
    const meta = [date, surface, traction].filter(Boolean).join(' · ');
    return { track: String(track), meta };
  }

  function refreshStatus(){
    if (!pdfDoc){
      statusPill.textContent = 'Laddar sheet.pdf…';
      btnDelete.style.display = 'none';
      return;
    }
    if (!current){
      statusPill.textContent = 'Ingen setup vald';
      btnDelete.style.display = 'none';
      return;
    }
    statusPill.textContent = `Vald setup · fält: ${Object.keys(current.fields||{}).length}`;
    btnDelete.style.display = '';
  }

  function renderBaselines(){
    baselineList.innerHTML = '';
    const baselines = [
      { kind:'carpet', title:'XRAY Basic ETS Carpet', meta:'Carpet · High', pdf:PDFS.carpet },
      { kind:'asphalt', title:'XRAY Basic ETS Asphalt', meta:'Asphalt · Medium', pdf:PDFS.asphalt },
    ];

    for (const b of baselines){
      const el = document.createElement('div');
      el.className = 'item';

      const left = document.createElement('div');
      left.innerHTML = `<strong>${escapeHtml(b.title)}</strong><small>${escapeHtml(b.meta)}</small>`;

      const actions = document.createElement('div');
      actions.className = 'actions';

      const copy = document.createElement('button');
      copy.className = 'btn';
      copy.textContent = 'Kopiera som ny';
      copy.onclick = () => {
        current = newBlankSetup();
        if (b.kind === 'carpet'){ current.fields["CARPET"] = true; current.fields["HIGH"] = true; }
        else { current.fields["ASPHALT"] = true; current.fields["MEDIUM"] = true; }

        all.unshift(current);
        saveAll(all);
        renderMyList();
        populateOverlayFromCurrent();
        refreshStatus();
      };

      const pdf = document.createElement('button');
      pdf.className = 'btn ghost';
      pdf.textContent = 'Öppna PDF';
      pdf.onclick = () => window.open(b.pdf, '_blank');

      actions.append(copy, pdf);
      el.append(left, actions);
      baselineList.appendChild(el);
    }
  }

  function renderMyList(){
    all = loadAll().sort((a,b)=> (b.meta?.updatedAt||'').localeCompare(a.meta?.updatedAt||''));
    const filtered = all.filter(matchFilters);

    myList.innerHTML = '';
    emptyHint.style.display = filtered.length ? 'none' : 'block';

    for (const s of filtered){
      const {track, meta} = listLabel(s);

      const el = document.createElement('div');
      el.className = 'item';

      const left = document.createElement('div');
      left.innerHTML = `<strong>${escapeHtml(track)}</strong><small>${escapeHtml(meta)}</small>`;

      const actions = document.createElement('div');
      actions.className = 'actions';

      const open = document.createElement('button');
      open.className = 'btn';
      open.textContent = 'Öppna';
      open.onclick = () => { current = s; populateOverlayFromCurrent(); refreshStatus(); };

      const dup = document.createElement('button');
      dup.className = 'btn ghost';
      dup.textContent = 'Kopiera';
      dup.onclick = () => {
        const copy = JSON.parse(JSON.stringify(s));
        copy.id = uid();
        copy.meta = { ...copy.meta, createdAt: nowISO(), updatedAt: nowISO() };
        all.unshift(copy);
        saveAll(all);
        renderMyList();
      };

      actions.append(open, dup);
      el.append(left, actions);
      myList.appendChild(el);
    }
  }

  function hardSave(){
    if (!current){
      current = newBlankSetup();
      all.unshift(current);
    }
    current.meta.updatedAt = nowISO();

    const arr = loadAll();
    const idx = arr.findIndex(x => x.id === current.id);
    if (idx >= 0) arr[idx] = current;
    else arr.unshift(current);
    saveAll(arr);
    renderMyList();
    alert('Sparad.');
  }

  function hardDelete(){
    if (!current) return;
    const arr = loadAll().filter(x => x.id !== current.id);
    saveAll(arr);
    current = null;
    renderMyList();
    populateOverlayFromCurrent();
    refreshStatus();
  }

  // Overlay
  let overlayNodes = [];

  function clearOverlay(){
    for (const n of overlayNodes) n.remove();
    overlayNodes = [];
  }

  function pdfRectToCss(rect){
    const r = pdfjsLib.Util.normalizeRect(rect);
    const v = viewport.convertToViewportRectangle(r);
    const [x1,y1,x2,y2] = v;
    const left = Math.min(x1,x2);
    const top = Math.min(y1,y2);
    const width = Math.abs(x2-x1);
    const height = Math.abs(y2-y1);
    return { left, top, width, height };
  }

  function buildOverlayNodes(widgets){
    clearOverlay();

    for (const w of widgets){
      const { left, top, width, height } = pdfRectToCss(w.rect);
      const minW = 14, minH = 14;
      const W = Math.max(width, minW);
      const H = Math.max(height, minH);

      const t = w.fieldType;

      if (t === "Btn"){
        if (w.radioButton){
          const el = document.createElement('input');
          el.type = 'radio';
          el.className = 'rad';
          el.name = w.fieldName;
          el.value = w.exportValue || "On";
          el.style.left = left + "px";
          el.style.top = top + "px";
          el.style.width = W + "px";
          el.style.height = H + "px";

          el.addEventListener('change', () => {
            if (!current) return;
            current.fields[w.fieldName] = el.value;
            current.meta.updatedAt = nowISO();
            refreshStatus();
          });

          stage.appendChild(el);
          overlayNodes.push(el);
        } else {
          const el = document.createElement('input');
          el.type = 'checkbox';
          el.className = 'chk';
          el.dataset.fname = w.fieldName;
          el.style.left = left + "px";
          el.style.top = top + "px";
          el.style.width = W + "px";
          el.style.height = H + "px";

          el.addEventListener('change', () => {
            if (!current) return;
            current.fields[w.fieldName] = el.checked;
            current.meta.updatedAt = nowISO();
            refreshStatus();
          });

          stage.appendChild(el);
          overlayNodes.push(el);
        }
      } else {
        const isMulti = !!w.multiLine || ((w.fieldFlags || 0) & 4096) === 4096;
        const el = document.createElement(isMulti ? 'textarea' : 'input');
        if (!isMulti) el.type = 'text';
        el.className = 'fld' + (H < 20 ? ' small' : '');
        el.dataset.fname = w.fieldName;

        el.style.left = left + "px";
        el.style.top = top + "px";
        el.style.width = W + "px";
        el.style.height = Math.max(18, H) + "px";

        el.addEventListener('input', () => {
          if (!current) return;
          current.fields[w.fieldName] = el.value;
          current.meta.updatedAt = nowISO();
          refreshStatus();
        });

        stage.appendChild(el);
        overlayNodes.push(el);
      }
    }

    populateOverlayFromCurrent();
  }

  function populateOverlayFromCurrent(){
    const f = current?.fields || {};
    const nodes = stage.querySelectorAll('input, textarea');

    for (const el of nodes){
      const fieldName = el.dataset.fname || el.name || '';
      if (!fieldName) continue;

      if (el.type === 'radio'){
        const wanted = f[fieldName];
        el.checked = wanted ? (String(wanted) === String(el.value)) : false;
      } else if (el.type === 'checkbox'){
        el.checked = !!f[fieldName];
      } else {
        el.value = String(f[fieldName] ?? '');
      }
    }
  }

  async function loadPdfAndBuildOverlay(){
    // disableWorker löser ofta "tom render" när worker från CDN blockas
    const loadingTask = pdfjsLib.getDocument({ url: "./sheet.pdf", disableWorker: true });
    pdfDoc = await loadingTask.promise;
    page = await pdfDoc.getPage(1);

    const scale = 1.6;
    viewport = page.getViewport({ scale });

    canvas.width = Math.ceil(viewport.width);
    canvas.height = Math.ceil(viewport.height);

    stage.style.width = canvas.width + "px";
    stage.style.height = canvas.height + "px";

    await page.render({ canvasContext: ctx, viewport }).promise;

    const annots = await page.getAnnotations({ intent: "display" });
    widgetAnnots = annots.filter(a => a.subtype === "Widget" && a.fieldName);

    buildOverlayNodes(widgetAnnots);
    statusPill.textContent = `Laddad: ${widgetAnnots.length} fält`;
  }

  // Events
  btnNew.onclick = () => {
    current = newBlankSetup();
    all.unshift(current);
    saveAll(all);
    renderMyList();
    populateOverlayFromCurrent();
    refreshStatus();
  };
  btnSave.onclick = hardSave;
  btnDelete.onclick = hardDelete;

  q.addEventListener('input', renderMyList);
  fSurface.addEventListener('input', renderMyList);
  fTraction.addEventListener('input', renderMyList);

  // Init
  renderBaselines();
  renderMyList();
  current = newBlankSetup();
  all.unshift(current);
  saveAll(all);
  refreshStatus();

  loadPdfAndBuildOverlay().then(() => {
    refreshStatus();
    populateOverlayFromCurrent();
  }).catch((e) => {
    const msg =
      "PDF-laddning misslyckades.\n\n" +
      "1) Kontrollera att sheet.pdf ligger i repots root.\n" +
      "2) Testa bumpa cache (sw.js).\n\n" +
      "Teknisk info:\n" + (e && (e.message || String(e)));
    showError(msg);
    statusPill.textContent = "Kunde inte läsa sheet.pdf";
    console.error(e);
  });

})();
</script>
</body>
</html>
